#!/usr/bin/env bash
set -euo pipefail

REAL_PIXI="/opt/pixi/bin/pixi"
HOME_PREFIX="/home/"

SUBCMD="${1:-}"

is_project_env_command() {
  case "$SUBCMD" in
    add|build|init|install|import|reinstall|remove|shell|shell-hook|update|upgrade|upload)
      return 0 ;;
    *) return 1 ;;
  esac
}

is_global_env_command() {
  case "$SUBCMD" in
    global)
      return 0 ;;
    *) return 1 ;;
  esac
}

find_project_root() {
  local dir="$PWD"
  while [[ "$dir" != "/" ]]; do
    if [[ -f "$dir/pixi.toml" || -f "$dir/pyproject.toml" ]]; then
      echo "$dir"
      return
    fi
    dir="$(dirname "$dir")"
  done
  echo "$PWD"
}

# Echo the project directory implied by --manifest-path in "$@", or nothing if absent/invalid.
get_manifest_path_dir() {
  local args=("$@")
  local i path dir
  for (( i = 0; i < ${#args[@]}; i++ )); do
    if [[ "${args[i]}" == "--manifest-path" ]]; then
      if (( i + 1 < ${#args[@]} )); then
        path="${args[i+1]}"
        break
      fi
    elif [[ "${args[i]}" == --manifest-path=* ]]; then
      path="${args[i]#--manifest-path=}"
      break
    fi
  done
  if [[ -z "${path:-}" ]]; then
    return
  fi
  # Derive project dir: if path looks like a manifest file, use its directory; else treat as directory.
  if [[ "$path" == *"/pixi.toml" || "$path" == *"/pyproject.toml" ]]; then
    dir="$(dirname "$path")"
  else
    dir="$path"
  fi
  echo "$dir"
}

block_project_env_if_in_home() {
  local project_dir manifest_dir
  manifest_dir="$(get_manifest_path_dir "$@")"

  if [[ -n "$manifest_dir" ]]; then
    if [[ "$manifest_dir" != ${HOME_PREFIX}* ]]; then
      return
    fi
    project_dir="$manifest_dir"
  else
    project_dir="$(find_project_root)"
  fi

  if [[ "$project_dir" == ${HOME_PREFIX}* ]]; then
    echo "Error: Pixi environments are not allowed for projects under ${HOME_PREFIX}." >&2
    echo "Project directory: ${project_dir}" >&2
    echo "Please move the project to a non-/home filesystem (e.g. /work/, /depot/) and try again." >&2
    exit 1
  fi
}

block_global_env_if_in_home() {
  local pixi_home="${PIXI_HOME:-"$HOME/.pixi"}"

  if [[ "$pixi_home" == ${HOME_PREFIX}* ]]; then
    echo "Error: Pixi global environments are not allowed under ${HOME_PREFIX}." >&2
    echo "Current PIXI_HOME: ${pixi_home}" >&2
    echo "Set PIXI_HOME to a non-/home location (e.g. /work/, /depot/) and retry." >&2
    exit 1
  fi
}

if is_project_env_command; then
  block_project_env_if_in_home "$@"
elif is_global_env_command; then
  block_global_env_if_in_home
fi

exec "$REAL_PIXI" "$@"