name: Lint YAML

on:
  pull_request:

permissions:
  contents: read

jobs:
  yaml-parse:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Install parser dependency
        run: |
          set -euo pipefail
          python3 -m pip install --upgrade pip
          python3 -m pip install pyyaml

      - name: Validate YAML files (check-only, advisory)
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          from pathlib import Path
          import yaml

          files = sorted(
              p for p in Path('.').rglob('*')
              if p.is_file() and p.suffix in {'.yml', '.yaml'}
          )

          excluded_prefixes = (
              Path('docker/dask-gateway-server'),
              Path('docker/kaniko-build-jobs'),
              Path('docs'),
              Path('slurm'),
              Path('.cursor'),
              Path('.git'),
          )

          filtered = []
          for p in files:
              if any(str(p).startswith(str(prefix) + '/') or p == prefix for prefix in excluded_prefixes):
                  continue
              filtered.append(p)

          if not filtered:
              print('No in-scope YAML files found.')
              raise SystemExit(0)

          for p in filtered:
              with p.open('r', encoding='utf-8') as f:
                  list(yaml.safe_load_all(f))

          print(f'Validated {len(filtered)} YAML file(s).')
          PY
